image: "dmatrix.azurecr.io/mlops:v8"

test:
  before_script:
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_rsa
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - export PATH=/home/root/.poetry/bin/:$PATH

  script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -e .
    - pytest -vv ./tests/*.py

staging:
  variables:
    UPSTREAM_MLTOOLS_BRANCH: $CI_COMMIT_REF_NAME
  stage: deploy
  trigger: ml-team/mlreferences
